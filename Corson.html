<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8" />
<title>CORS Auto-Downloader (uso legale)</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  body { font-family: system-ui, Arial; max-width: 780px; margin: 32px auto; padding: 0 16px; }
  input, button, select { font-size: 15px; padding: 10px; width: 100%; box-sizing: border-box; margin-top: 8px; }
  button { background: #0066cc; color: white; border: none; border-radius: 6px; cursor: pointer; }
  button:hover { background: #0052a3; }
  button:disabled { background: #ccc; cursor: not-allowed; }
  .share-section { margin-top: 20px; padding: 15px; background: #e8f4fd; border-radius: 8px; display: none; }
  .share-section.show { display: block; }
  .share-link { background: white; padding: 10px; border-radius: 4px; word-break: break-all; margin: 8px 0; font-family: monospace; font-size: 13px; }
  .copy-btn { background: #28a745; padding: 8px 16px; width: auto; margin-top: 8px; }
  .copy-btn:hover { background: #218838; }
  pre { background:#f4f4f4; padding:10px; white-space:pre-wrap; word-break:break-word; max-height: 400px; overflow-y: auto; }
  .small { font-size: 13px; color: #555; }
  .log { margin-top:12px; }
  .status { padding: 12px; border-radius: 6px; margin: 12px 0; font-weight: 500; }
  .status.success { background: #d4edda; color: #155724; }
  .status.error { background: #f8d7da; color: #721c24; }
  .status.info { background: #d1ecf1; color: #0c5460; }
  .spinner { display: inline-block; width: 16px; height: 16px; border: 3px solid #f3f3f3; border-top: 3px solid #0066cc; border-radius: 50%; animation: spin 1s linear infinite; margin-right: 8px; }
  @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  .auto-download-page { display: none; text-align: center; padding: 40px 20px; }
  .auto-download-page.active { display: block; }
  .main-page.hidden { display: none; }
  .progress { width: 100%; height: 6px; background: #e0e0e0; border-radius: 3px; overflow: hidden; margin: 20px 0; }
  .progress-bar { height: 100%; background: linear-gradient(90deg, #0066cc, #00aaff); animation: progress 2s ease-in-out; }
  @keyframes progress { 0% { width: 0%; } 100% { width: 100%; } }
</style>
</head>
<body>
  <div class="main-page" id="mainPage">
    <h1>ðŸš€ CORS Auto-Downloader</h1>
    <p class="small">Inserisci l'URL del file e genera un link condivisibile. Chi aprirÃ  il link vedrÃ  partire il download automaticamente! (Solo contenuti legali)</p>

    <input id="url" placeholder="https://example.com/file.ext" />
    <select id="proxyMode">
      <option value="sequential">Prova tutti i proxy in sequenza</option>
      <option value="first">Usa solo il primo proxy</option>
    </select>
    <button id="start">Genera link condivisibile</button>

    <div class="share-section" id="shareSection">
      <h3>ðŸ“¤ Condividi questo link</h3>
      <p class="small">Copia questo link per condividerlo con altri. Il download partirÃ  automaticamente!</p>
      <div class="share-link" id="shareLink"></div>
      <button class="copy-btn" id="copyBtn">ðŸ“‹ Copia link</button>
    </div>

    <div id="status"></div>
    <div class="log" id="log"></div>
  </div>

  <div class="auto-download-page" id="autoDownloadPage">
    <h1>ðŸ“¥ Download in corso...</h1>
    <div class="progress">
      <div class="progress-bar"></div>
    </div>
    <p id="autoStatus" style="font-size: 16px; margin: 20px 0;"></p>
    <div class="log" id="autoLog"></div>
  </div>

<script>
(function(){
  const proxies = [
    { name: "corsproxy.io", build: url => "https://corsproxy.io/?" + url },
    { name: "cors-anywhere", build: url => "https://cors-anywhere.herokuapp.com/" + url },
    { name: "thingproxy", build: url => "https://thingproxy.freeboard.io/fetch/" + url },
    { name: "allorigins", build: url => "https://api.allorigins.win/raw?url=" + encodeURIComponent(url) }
  ];

  const logEl = document.getElementById("log");
  const statusEl = document.getElementById("status");
  const shareSection = document.getElementById("shareSection");
  const shareLinkEl = document.getElementById("shareLink");
  const urlInput = document.getElementById("url");
  const startBtn = document.getElementById("start");
  const mainPage = document.getElementById("mainPage");
  const autoDownloadPage = document.getElementById("autoDownloadPage");
  const autoStatusEl = document.getElementById("autoStatus");
  const autoLogEl = document.getElementById("autoLog");

  function log(...args){
    const t = document.createElement("pre");
    t.textContent = args.join(" ");
    logEl.prepend(t);
  }

  function autoLog(...args){
    const t = document.createElement("pre");
    t.textContent = args.join(" ");
    autoLogEl.prepend(t);
  }

  function setStatus(message, type = "info") {
    statusEl.innerHTML = `<div class="status ${type}">${message}</div>`;
  }

  function setAutoStatus(message) {
    autoStatusEl.innerHTML = message;
  }

  function extractFilename(url, response) {
    try {
      const cd = response.headers.get("content-disposition");
      if (cd) {
        const m = cd.match(/filename\*?=(?:UTF-8'')?["']?([^;"']+)/i);
        if (m && m[1]) return decodeURIComponent(m[1]);
      }
    } catch(e){}
    try {
      const u = new URL(url);
      const seg = u.pathname.split("/").filter(Boolean).pop();
      if (seg) return seg;
    } catch(e){}
    return "download.bin";
  }

  async function fetchWithTimeout(resource, options = {}) {
    const { timeout = 20000 } = options;
    const controller = new AbortController();
    const id = setTimeout(() => controller.abort(), timeout);
    try {
      const resp = await fetch(resource, { ...options, signal: controller.signal });
      clearTimeout(id);
      return resp;
    } catch (e) {
      clearTimeout(id);
      throw e;
    }
  }

  async function tryProxy(proxy, originalUrl, isAuto = false) {
    const proxUrl = proxy.build(originalUrl);
    const logFunc = isAuto ? autoLog : log;
    logFunc(`[Prova] ${proxy.name}`);
    try {
      const headers = { "x-requested-with": "XMLHttpRequest" };
      const resp = await fetchWithTimeout(proxUrl, { method: "GET", mode: "cors", headers, timeout: 25000 });

      if (!resp.ok) {
        logFunc(`[Errore] ${proxy.name} risponde con status ${resp.status}`);
        return { ok:false, reason: `HTTP ${resp.status}` };
      }

      const ct = resp.headers.get("content-type") || "";
      const blob = await resp.blob();

      if ((ct.includes("text/html") || ct.includes("application/json") || ct.includes("text/plain")) && blob.size < 200000) {
        const txt = await blob.text();
        logFunc(`[Avviso] ${proxy.name} ha restituito una pagina testuale`);
        return { ok:false, reason: "Probabile pagina di errore" };
      }

      const filename = extractFilename(originalUrl, resp);
      return { ok:true, blob, filename, contentType: ct, proxUrl };
    } catch (err) {
      logFunc(`[Errore] ${proxy.name}: ${err && err.name ? err.name : err}`);
      return { ok:false, reason: err && err.message ? err.message : String(err) };
    }
  }

  function doDownload(blob, filename) {
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename || "download.bin";
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(() => URL.revokeObjectURL(url), 30000);
  }

  function generateShareableLink(fileUrl, mode) {
    const params = new URLSearchParams();
    params.set("url", fileUrl);
    params.set("mode", mode);
    params.set("auto", "1");
    return window.location.origin + window.location.pathname + "?" + params.toString();
  }

  function showShareLink(fileUrl, mode) {
    const shareUrl = generateShareableLink(fileUrl, mode);
    shareLinkEl.textContent = shareUrl;
    shareSection.classList.add("show");
  }

  function generateShareLink() {
    logEl.innerHTML = "";
    statusEl.innerHTML = "";
    shareSection.classList.remove("show");

    const originalUrl = urlInput.value.trim();
    if (!originalUrl) { 
      setStatus("âŒ Inserisci un URL valido", "error");
      return; 
    }

    try { new URL(originalUrl); } catch(e) { 
      setStatus("âŒ URL non valido", "error");
      return; 
    }

    const mode = document.getElementById("proxyMode").value;
    showShareLink(originalUrl, mode);
    setStatus("âœ… Link generato! Ora puoi copiarlo e condividerlo.", "success");
    log(`[Link generato] Pronto per la condivisione`);
  }

  async function autoDownload(fileUrl, mode) {
    mainPage.classList.add("hidden");
    autoDownloadPage.classList.add("active");
    
    setAutoStatus(`ðŸ”„ Avvio download automatico...`);
    autoLog(`[Auto-Download] Elaborazione: ${fileUrl}`);

    for (const p of proxies) {
      const result = await tryProxy(p, fileUrl, true);
      if (result.ok) {
        autoLog(`[âœ“ Successo] Download tramite ${p.name}`);
        setAutoStatus(`âœ… Download avviato! File: ${result.filename}`);
        doDownload(result.blob, result.filename);
        
        setTimeout(() => {
          setAutoStatus(`âœ… Download completato! Puoi chiudere questa pagina.`);
        }, 1000);
        return;
      } else {
        autoLog(`[âœ— Fallito] ${p.name}: ${result.reason || "sconosciuto"}`);
      }
      if (mode === "first") break;
    }
    
    setAutoStatus("âŒ Impossibile scaricare il file. Verifica l'URL o riprova piÃ¹ tardi.");
    autoLog("[Fine] Tutti i proxy hanno fallito");
  }

  // Gestione click bottone - genera solo il link
  startBtn.addEventListener("click", () => generateShareLink());

  // Gestione invio con Enter
  urlInput.addEventListener("keypress", (e) => {
    if (e.key === "Enter") generateShareLink();
  });

  // Copia link condivisibile
  document.getElementById("copyBtn").addEventListener("click", async () => {
    const link = shareLinkEl.textContent;
    try {
      await navigator.clipboard.writeText(link);
      const btn = document.getElementById("copyBtn");
      const originalText = btn.textContent;
      btn.textContent = "âœ“ Copiato!";
      setTimeout(() => { btn.textContent = originalText; }, 2000);
    } catch(e) {
      const textarea = document.createElement("textarea");
      textarea.value = link;
      document.body.appendChild(textarea);
      textarea.select();
      document.execCommand("copy");
      textarea.remove();
      alert("Link copiato negli appunti!");
    }
  });

  // Auto-start se c'Ã¨ il parametro auto nell'URL
  window.addEventListener("DOMContentLoaded", () => {
    const params = new URLSearchParams(window.location.search);
    const fileUrl = params.get("url");
    const mode = params.get("mode") || "sequential";
    const auto = params.get("auto");

    if (fileUrl && auto === "1") {
      // Avvia automaticamente il download senza mostrare la pagina principale
      setTimeout(() => {
        autoDownload(fileUrl, mode);
      }, 500);
    }
  });

})();
</script>
</body>
</html>

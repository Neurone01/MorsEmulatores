<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>SkyEmu Player</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      background: #000;
      overflow: hidden;
    }

    #canvas {
      width: 100%;
      height: 100%;
      display: block;
      background: #000;
    }

    #status {
      position: fixed;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      color: #ccc;
      font-family: sans-serif;
      font-size: 14px;
      background: rgba(0, 0, 0, 0.5);
      padding: 6px 12px;
      border-radius: 8px;
      z-index: 5;
    }
  </style>
</head>
<body>

<div id="status">Caricamento...</div>

<canvas id="canvas" class="emscripten"></canvas>
<input id="fileInput0" type="file" style="display:none">

<!-- Pre-carica BIOS e configura Module -->
<script>
"use strict";

const params = new URLSearchParams(location.search);
const romURL = decodeURIComponent(params.get("rom"));
const title = decodeURIComponent(params.get("title") || "Gioco");
const system = params.get("system") || "gba";
const STATUS = document.getElementById("status");

const biosMap = {
  gba: {
    url: "https://cdn.jsdelivr.net/gh/Neurone01/MorsEmulatores@main/Bios/gba_bios.bin",
    path: "/offline/gba_bios.bin"
  },
  gbc: {
    url: "https://cdn.jsdelivr.net/gh/Neurone01/MorsEmulatores@main/Bios/gbc_bios.bin",
    path: "/offline/gbc_bios.bin"
  },
  gb: {
    url: "https://cdn.jsdelivr.net/gh/Neurone01/MorsEmulatores@main/Bios/dmg0_rom.bin",
    path: "/offline/dmg_boot.bin"
  }
};

function setStatus(msg) {
  STATUS.textContent = msg;
  console.log("üì¢", msg);
}

async function fetchBinary(url) {
  const res = await fetch(url, { mode: "cors" });
  if (!res.ok) throw new Error(`HTTP ${res.status}`);
  return new Uint8Array(await res.arrayBuffer());
}

// PRE-CARICA IL BIOS PRIMA DI SKYEMU.JS
(async function() {
  try {
    setStatus("Pre-caricamento BIOS...");
    const biosInfo = biosMap[system];
    if (biosInfo) {
      const biosData = await fetchBinary(biosInfo.url);
      window.PRELOADED_BIOS = {
        data: biosData,
        path: biosInfo.path
      };
      console.log(`‚úÖ BIOS pre-caricato: ${biosData.length} bytes`);
    }
  } catch (err) {
    console.warn("‚ö†Ô∏è Errore BIOS:", err);
  }
})();

// Configura Module
window.Module = {
  preRun: [],
  postRun: [],
  onRuntimeInitialized: function() {
    console.log("‚úÖ Runtime pronto");
    
    // Intercetta FS.syncfs per monitorare i salvataggi
    if (typeof FS !== 'undefined' && FS.syncfs) {
      const originalSyncfs = FS.syncfs;
      FS.syncfs = function(populate, callback) {
        console.log("üíæ Sincronizzazione filesystem...");
        originalSyncfs.call(FS, populate, function(err) {
          if (!err && !populate) {
            console.log("‚úÖ Salvataggio sincronizzato con IndexedDB");
          }
          if (callback) callback(err);
        });
      };
    }
    
    // Aspetta che /offline sia montato e poi inietta BIOS
    const injectBIOS = () => {
      if (!window.PRELOADED_BIOS || typeof FS === 'undefined') return;
      
      try {
        // Verifica se /offline esiste
        FS.lookupPath("/offline");
        
        // Directory esiste, inietta BIOS
        FS.writeFile(window.PRELOADED_BIOS.path, window.PRELOADED_BIOS.data);
        console.log(`‚úÖ BIOS iniettato: ${window.PRELOADED_BIOS.path}`);
        
        const verify = FS.readFile(window.PRELOADED_BIOS.path);
        console.log(`‚úÖ BIOS verificato: ${verify.length} bytes`);
      } catch (e) {
        // /offline non esiste ancora, riprova tra poco
        if (e.errno === 44) {
          setTimeout(injectBIOS, 100);
        } else {
          console.error("‚ùå Errore BIOS:", e);
        }
      }
    };
    
    // Inizia a provare dopo 100ms
    setTimeout(injectBIOS, 100);
  },
  printErr: function(text) {
    // Cattura i messaggi di salvataggio di SkyEmu
    if (text.includes('Saved:')) {
      const match = text.match(/Saved: (.+?) \(size: (\d+)\)/);
      if (match) {
        console.log(`üíæ Salvataggio creato: ${match[1]} (${match[2]} bytes)`);
      }
    } else if (!text.includes('warning') && !text.includes('Uncaught')) {
      console.error("SkyEmu:", text);
    }
  }
};

// Gestisci errori globali
window.addEventListener('error', function(e) {
  if (e.filename && e.filename.includes('SkyEmu')) {
    e.preventDefault();
    return true;
  }
});
</script>

<!-- Core emulatore -->
<script src="https://web.skyemu.app/SkyEmu.js"></script>

<!-- Carica ROM -->
<script>
function setFileInput(fileInput, file) {
  const dt = new DataTransfer();
  dt.items.add(file);
  fileInput.files = dt.files;
  fileInput.dispatchEvent(new Event("change", { bubbles: true }));
}

async function launchROM() {
  try {
    setStatus(`Caricamento ${title}...`);
    const romData = await fetchBinary(romURL);
    const filename = romURL.split("/").pop().replace(/%20/g, " ");
    
    console.log(`üì¶ ROM: ${filename} (${romData.length} bytes)`);

    const blob = new Blob([romData], { type: "application/octet-stream" });
    const file = new File([blob], filename);
    setFileInput(document.getElementById("fileInput0"), file);

    setTimeout(() => {
      STATUS.style.display = "none";
      console.log("‚úÖ Gioco avviato");
    }, 2000);
  } catch (err) {
    setStatus("‚ùå Errore: " + err.message);
    console.error("üí• Errore:", err);
  }
}

launchROM();
</script>
</body>
</html>

<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Player</title>
  <style>
    html,body{height:100%;margin:0;background:#000;color:#fff;font-family:system-ui,Arial}
    #status{position:fixed;left:50%;top:12px;transform:translateX(-50%);background:rgba(0,0,0,0.6);padding:8px 12px;border-radius:10px;z-index:10}
    #back{position:fixed;right:16px;bottom:16px;background:#111;padding:10px 14px;border-radius:10px;cursor:pointer}
    canvas{display:block;width:100%;height:100vh;background:#000}
    #hiddenFiles{display:none}
  </style>
</head>
<body>
  <div id="status">Preparazione...</div>
  <button id="back" onclick="goBack()">← Libreria</button>
  <canvas id="canvas" class="emscripten"></canvas>
  <input id="fileInput0" type="file" style="display:none" />
  <div id="hiddenFiles"></div>

  <!-- emulatore: modifica il src se necessario (SkyEmu.js) -->
  <script src="https://web.skyemu.app/SkyEmu.js"></script>

<script>
"use strict";

const STATUS = document.getElementById("status");
function setStatus(s){ STATUS.textContent = s; console.log("[STATUS]", s); }

function goBack(){ if(document.fullscreenElement) document.exitFullscreen(); location.href = "index.html"; }

function params(){
  const p = new URLSearchParams(location.search);
  return {
    url: p.get("url") || p.get("rom") || null,
    title: p.get("title") || "Gioco",
    system: (p.get("system") || "gba").toLowerCase()
  };
}

function waitForModule(timeoutMs = 8000){
  return new Promise((resolve) => {
    if(window.Module && (typeof window.Module !== "undefined")) return resolve(window.Module);
    const start = Date.now();
    const iv = setInterval(()=>{
      if(window.Module){
        clearInterval(iv);
        return resolve(window.Module);
      }
      if(Date.now() - start > timeoutMs){
        clearInterval(iv);
        return resolve(null);
      }
    }, 150);
  });
}

async function fetchBinary(url){
  setStatus("Scaricamento ROM…");
  const r = await fetch(url, {mode:"cors"});
  if(!r.ok) throw new Error(`HTTP ${r.status}`);
  const ab = await r.arrayBuffer();
  return new Uint8Array(ab);
}

// utility to synthesize file input
function setFileInputFromUint8(fileInputElem, bytes, filename){
  try{
    const blob = new Blob([bytes], { type: "application/octet-stream" });
    const file = new File([blob], filename, { type: "application/octet-stream" });
    const dt = new DataTransfer();
    dt.items.add(file);
    fileInputElem.files = dt.files;
    // dispatch change to notify emulator code
    fileInputElem.dispatchEvent(new Event("change",{bubbles:true}));
    setStatus("ROM pronta, avvio emulatore...");
  }catch(e){
    console.error("setFileInputFromUint8 error", e);
    throw e;
  }
}

async function main(){
  const p = params();
  if(!p.url){
    setStatus("Nessuna ROM specificata (url mancante)");
    return;
  }
  setStatus(`Preparazione: ${p.title}`);

  // try to wait for Module (emulator) but don't require it before download
  const modulePromise = waitForModule(12000);

  // attempt to download ROM: prefer direct URL; if it's a GitHub raw/jsDelivr link it's fine
  try{
    const data = await fetchBinary(p.url);
    const filename = decodeURIComponent((new URL(p.url)).pathname.split("/").pop() || `${p.title.replace(/\s+/g,"_")}.gba`);
    // put into file input so emulator picks it
    const input = document.getElementById("fileInput0");
    setFileInputFromUint8(input, data, filename);

    // hide status after a moment and/or request fullscreen
    setTimeout(()=>{ document.getElementById("status").style.display="none"; try{ document.documentElement.requestFullscreen() }catch{} }, 900);

    const Module = await modulePromise;
    if(!Module){
      console.warn("Module non presente o timeout; l'emulatore potrebbe caricare comunque quando pronto.");
      // nothing to call manually: many emulators detect fileInput change themselves
      return;
    }

    // some emulators expect Module.callMain; we avoid forcing it.
    // If the emulator exposes a specific API for loading file from memory, you'd call it here.
    setStatus("Emulatore pronto.");
  }catch(err){
    console.error("ERRORE:", err);
    setStatus("ERRORE: " + (err.message || err));
  }
}

// run
main();
</script>

</body>
</html>

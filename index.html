<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Retro Library</title>
<style>
  :root{
    --bg:#0b0b0d; --card:#0f1114; --muted:#97a0a9; --accent:#00aaff;
  }
  body{margin:0;background:var(--bg);color:#fff;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial;}
  header{display:flex;align-items:center;flex-wrap:wrap;gap:10px;padding:15px 20px;background:#0d0f11;border-bottom:1px solid #111;}
  header h1{margin:0;font-size:18px;font-weight:600}
  .controls{display:flex;gap:10px;margin-left:auto;align-items:center;flex-wrap:wrap}
  input,select{background:#14171a;border:1px solid #222;color:#fff;border-radius:8px;padding:8px}
  main{padding:15px}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:15px;}
  .card{background:var(--card);border-radius:12px;padding:10px;display:flex;flex-direction:column;gap:10px;box-shadow:0 2px 10px rgba(0,0,0,0.4);}
  .thumb{background:#0a0a0a;display:flex;align-items:center;justify-content:center;border-radius:8px;height:70px;}
  .thumb img{max-width:100%;max-height:100%;object-fit:contain;}
  .title{font-weight:600;font-size:14px;line-height:1.3;word-break:break-word;white-space:normal;}
  .sub{font-size:12px;color:var(--muted)}
  .foot{display:flex;justify-content:space-between;align-items:center;margin-top:auto}
  .play{background:var(--accent);border:0;border-radius:8px;color:#001018;padding:6px 8px;font-weight:700;cursor:pointer}
  .small{font-size:12px;background:#111;padding:4px 6px;border-radius:6px}
  #status{padding:10px 20px;color:var(--muted);font-size:13px}
</style>
</head>
<body>
<header>
  <h1>Retro Library</h1>
  <div class="controls">
    <input id="q" placeholder="Cerca gioco..." />
    <select id="systemFilter">
      <option value="all">Tutti</option>
      <option value="gba">GBA</option>
      <option value="gbc">GBC</option>
      <option value="gb">GB</option>
    </select>
    <label><input id="eurOnly" type="checkbox" /> Solo EUR</label>
  </div>
</header>
<div id="status">Caricamento giochi...</div>
<main><div id="grid" class="grid"></div></main>

<script>
(async()=>{
  const GITHUB_OWNER="AlexBlackmore";
  const GITHUB_REPO="roms";
  const BRANCH="master";

  const grid=document.getElementById("grid");
  const status=document.getElementById("status");
  const qInput=document.getElementById("q");
  const sysFilter=document.getElementById("systemFilter");
  const eurOnly=document.getElementById("eurOnly");

  const logos={
    gba:"https://upload.wikimedia.org/wikipedia/commons/5/50/Game_Boy_Advance_logo.svg",
    gb:"https://upload.wikimedia.org/wikipedia/commons/f/f2/Nintendo_Game_Boy_Logo.svg",
    gbc:"https://upload.wikimedia.org/wikipedia/commons/c/c5/Game_Boy_Color_logo.svg"
  };

  async function fetchFolder(folder){
    const url=`https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${folder}`;
    try{
      const res=await fetch(url);
      if(!res.ok)return [];
      return await res.json();
    }catch{return [];}
  }

  function jsdelivr(folder,name){
    return `https://cdn.jsdelivr.net/gh/${GITHUB_OWNER}/${GITHUB_REPO}@${BRANCH}/${folder}/${encodeURIComponent(name)}`;
  }

  function isEur(name){
    return /\(e\)|\[e\]|eur|europe/i.test(name);
  }

  function systemFromFolder(f){
    if(f.startsWith("gba"))return"gba";
    if(f.startsWith("gbc"))return"gbc";
    return"gb";
  }

  function cardHtml(g){
    const logo=logos[g.system]||logos.gba;
    return `
    <article class="card">
      <div class="thumb"><img src="${logo}" alt="${g.system}"></div>
      <div class="title">${g.title}</div>
      <div class="sub">${g.system.toUpperCase()} ${g.eur?"â€¢ EUR":""}</div>
      <div class="foot"><button class="play" data-url="${g.url}" data-title="${encodeURIComponent(g.title)}">PLAY</button></div>
    </article>`;
  }

  async function loadGames(){
    const folders=["gba","gbc","gb"];
    const all=[];
    for(const f of folders){
      const files=await fetchFolder(f);
      for(const file of files){
        if(file.type!=="file")continue;
        const ext=file.name.split(".").pop().toLowerCase();
        if(!["gba","gbc","gb","zip"].includes(ext))continue;
        all.push({
          title:file.name,
          system:systemFromFolder(f),
          url:jsdelivr(f,file.name),
          eur:isEur(file.name)
        });
      }
    }
    return all;
  }

  function render(games){
    const q=qInput.value.toLowerCase();
    const sys=sysFilter.value;
    const eur=eurOnly.checked;

    const filtered=games.filter(g=>{
      if(sys!=="all" && g.system!==sys)return false;
      if(eur && !g.eur)return false;
      if(q && !g.title.toLowerCase().includes(q))return false;
      return true;
    });

    grid.innerHTML=filtered.map(cardHtml).join("")||"<div>Nessun gioco trovato</div>";
    document.querySelectorAll(".play").forEach(b=>{
      b.onclick=()=>{
        const url=b.dataset.url;
        const title=decodeURIComponent(b.dataset.title);
        location.href=`play.html?rom=${encodeURIComponent(url)}&title=${encodeURIComponent(title)}`;
      };
    });
  }

  const games=await loadGames();
  status.textContent=`Giochi caricati: ${games.length}`;
  render(games);

  qInput.oninput=sysFilter.onchange=eurOnly.onchange=()=>render(games);
})();
</script>
</body>
</html>

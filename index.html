<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MorsEmulatores</title>
<style>
  body {
    background: #0a0a0a;
    color: #cce7ff;
    font-family: "Segoe UI", sans-serif;
    margin: 0;
    padding: 0;
    text-align: center;
  }

  header {
    position: sticky;
    top: 0;
    background: rgba(0, 15, 35, 0.95);
    padding: 10px;
    z-index: 10;
    backdrop-filter: blur(10px);
  }

  input[type="text"] {
    width: 80%;
    max-width: 400px;
    padding: 10px;
    margin: 10px;
    border-radius: 8px;
    border: none;
    background: rgba(255, 255, 255, 0.1);
    color: #fff;
    font-size: 16px;
  }

  #filterPlatform {
    background: rgba(255,255,255,0.08);
    border: 0;
    padding: 10px 12px;
    border-radius: 8px;
    color: #9fb0c0;
    cursor: pointer;
    transition: 0.3s;
  }

  #filterPlatform:hover {
    background: rgba(255,255,255,0.15);
  }

  .game-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
    gap: 16px;
    padding: 20px;
  }

  .game-card {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 12px;
    padding: 10px;
    transition: 0.3s;
  }

  .game-card:hover {
    transform: scale(1.05);
    background: rgba(255,255,255,0.1);
  }

  .game-card img {
    width: 100%;
    height: 100px;
    object-fit: contain;
    border-radius: 8px;
    background: #000;
  }

  .title {
    margin-top: 8px;
    font-size: 14px;
    color: #fff;
    word-wrap: break-word;
  }

  .arrow-up {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: #002b55;
    color: #cce7ff;
    border: none;
    border-radius: 50%;
    width: 45px;
    height: 45px;
    cursor: pointer;
    display: none;
    font-size: 22px;
    transition: 0.3s;
  }

  .arrow-up:hover {
    background: #004a88;
  }

  /* Loader */
  #loader {
    position: fixed;
    inset: 0;
    background: #001122;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 999;
    color: #7fc6ff;
    font-size: 18px;
    font-weight: 500;
    transition: opacity 1s ease;
  }

  .progress-container {
    width: 70%;
    max-width: 400px;
    background: rgba(255,255,255,0.1);
    border-radius: 10px;
    overflow: hidden;
    margin-top: 20px;
  }

  .progress-bar {
    width: 0%;
    height: 10px;
    background: linear-gradient(90deg, #007bff, #00bfff);
    border-radius: 10px;
    transition: width 0.3s;
  }

</style>
</head>
<body>
  <div id="loader">
    <div>Caricamento giochi...</div>
    <div class="progress-container"><div class="progress-bar"></div></div>
    <div id="progress-text">0%</div>
  </div>

  <header>
    <input type="text" id="search" placeholder="Cerca gioco...">
    <br>
    <button id="filterPlatform">GBA</button>
  </header>

  <div class="game-grid" id="gameList"></div>
  <button class="arrow-up" id="arrowUp">â†‘</button>

  <script>
    const logos = {
      gba: "https://upload.wikimedia.org/wikipedia/commons/5/50/Game_Boy_Advance_logo.svg",
      gb: "https://upload.wikimedia.org/wikipedia/commons/f/f2/Nintendo_Game_Boy_Logo.svg",
      gbc: "https://upload.wikimedia.org/wikipedia/commons/c/c5/Game_Boy_Color_logo.svg"
    };

    const gameList = document.getElementById("gameList");
    const loader = document.getElementById("loader");
    const bar = document.querySelector(".progress-bar");
    const text = document.getElementById("progress-text");

    const sources = [
      "https://raw.githubusercontent.com/Neurone01/MorsEmulatores/refs/heads/main/games.json",
      "https://api.github.com/repos/AlexBlackmore/roms/contents/gba",
      "https://api.github.com/repos/AlexBlackmore/roms/contents/gb",
      "https://api.github.com/repos/AlexBlackmore/roms/contents/gbc"
    ];

    async function fetchAll() {
      let allGames = [];
      let count = 0;

      for (const src of sources) {
        try {
          const res = await fetch(src);
          const data = await res.json();

          if (Array.isArray(data)) {
            data.forEach(g => {
              if (g.name && (g.name.includes("(Europe)") || g.name.includes("(EUR)"))) {
                const system = src.includes("/gba") ? "gba" : src.includes("/gbc") ? "gbc" : src.includes("/gb") ? "gb" : (g.platform || "gba");
                allGames.push({
                  name: g.name.replace(".gba","").replace(".gbc","").replace(".gb",""),
                  url: `https://cdn.jsdelivr.net/gh/AlexBlackmore/roms@master/${system}/${g.name}`,
                  platform: system,
                  image: logos[system]
                });
              }
            });
          } else {
            // games.json
            data.forEach(g => {
              const system = g.platform.toLowerCase();
              allGames.push({
                name: g.name,
                url: g.url,
                platform: system,
                image: logos[system]
              });
            });
          }

          count++;
          const percent = Math.round((count / sources.length) * 100);
          bar.style.width = percent + "%";
          text.textContent = percent + "%";
        } catch (e) {
          console.error("Errore nel fetch:", e);
        }
      }

      // rimuovi duplicati
      allGames = allGames.filter((v,i,a)=>a.findIndex(t=>(t.name===v.name))===i);
      return allGames;
    }

    function renderGames(list) {
      gameList.innerHTML = list.map(g => `
        <div class="game-card" data-platform="${g.platform}">
          <img src="${g.image}">
          <div class="title">${g.name}</div>
          <button onclick="play('${g.url}','${encodeURIComponent(g.name)}','${g.platform}')"
            style="margin-top:8px;padding:6px 12px;border:none;border-radius:8px;background:#004a88;color:#fff;cursor:pointer;">Play</button>
        </div>`).join('');
    }

    async function init() {
      const allGames = await fetchAll();
      loader.style.opacity = 0;
      setTimeout(()=>loader.style.display="none",1000);
      renderGames(allGames);
      setupSearchAndFilters(allGames);
    }

    function setupSearchAndFilters(allGames) {
      const search = document.getElementById("search");
      const filterBtn = document.getElementById("filterPlatform");
      let currentPlatform = "gba";

      function update() {
        const q = search.value.toLowerCase();
        const filtered = allGames.filter(g =>
          g.platform === currentPlatform && g.name.toLowerCase().includes(q)
        );
        renderGames(filtered);
      }

      search.addEventListener("input", update);

      filterBtn.addEventListener("click", () => {
        currentPlatform = currentPlatform === "gba" ? "gbc" : currentPlatform === "gbc" ? "gb" : "gba";
        filterBtn.textContent = currentPlatform.toUpperCase();
        update();
      });

      update();
    }

    function play(url, title, system) {
      const biosMap = {
        gba: "https://cdn.jsdelivr.net/gh/Neurone01/MorsEmulatores@main/Bios/gba_bios.bin",
        gbc: "https://cdn.jsdelivr.net/gh/Neurone01/MorsEmulatores@main/Bios/gbc_bios.bin",
        gb: "https://cdn.jsdelivr.net/gh/Neurone01/MorsEmulatores@main/Bios/dmg0_rom.bin"
      };
      location.href = `play.html?rom=${encodeURIComponent(url)}&title=${encodeURIComponent(title)}&system=${system}&bios=${encodeURIComponent(biosMap[system])}`;
    }

    const arrow = document.getElementById("arrowUp");
    window.addEventListener("scroll", () => {
      arrow.style.display = window.scrollY > 200 ? "block" : "none";
    });
    arrow.addEventListener("click", ()=>window.scrollTo({top:0,behavior:'smooth'}));

    init();
  </script>
</body>
</html>

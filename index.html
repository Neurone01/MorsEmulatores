<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MorsEmulatores</title>
<style>
  body {
    background: #0b0e1a;
    color: #d4eaff;
    font-family: "Segoe UI", sans-serif;
    margin: 0;
    padding: 0;
  }

  /* Navbar superiore */
  nav {
    position: sticky;
    top: 0;
    z-index: 10;
    background: rgba(0, 25, 60, 0.95);
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 12px 10px;
    gap: 12px;
    backdrop-filter: blur(10px);
  }

  nav input[type="text"] {
    width: 45%;
    max-width: 400px;
    padding: 10px;
    border-radius: 8px;
    border: none;
    background: rgba(255,255,255,0.1);
    color: #fff;
    font-size: 15px;
  }

  nav button {
    background: transparent;
    border: 1px solid rgba(255,255,255,0.2);
    color: #aad8ff;
    padding: 8px 14px;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  nav button:hover, nav button.active {
    background: #007bff;
    color: #fff;
  }

  /* Griglia giochi */
  .game-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
    gap: 16px;
    padding: 20px;
  }

  .game-card {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 12px;
    padding: 10px;
    transition: 0.3s;
  }

  .game-card:hover {
    transform: scale(1.05);
    background: rgba(255,255,255,0.1);
  }

  .game-card img {
    width: 100%;
    height: 100px;
    object-fit: contain;
    border-radius: 8px;
    background: #000;
  }

  .title {
    margin-top: 8px;
    font-size: 14px;
    color: #fff;
    word-wrap: break-word;
  }

  .arrow-up {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: #003c80;
    color: #cce7ff;
    border: none;
    border-radius: 50%;
    width: 45px;
    height: 45px;
    cursor: pointer;
    display: none;
    font-size: 22px;
    transition: 0.3s;
  }

  .arrow-up:hover {
    background: #0057c0;
  }

  /* Loader */
  #loader {
    position: fixed;
    inset: 0;
    background: #001122;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 999;
    color: #7fc6ff;
    font-size: 18px;
    font-weight: 500;
    transition: opacity 1s ease;
  }

  .progress-container {
    width: 70%;
    max-width: 400px;
    background: rgba(255,255,255,0.1);
    border-radius: 10px;
    overflow: hidden;
    margin-top: 20px;
  }

  .progress-bar {
    width: 0%;
    height: 10px;
    background: linear-gradient(90deg, #007bff, #00bfff);
    border-radius: 10px;
    transition: width 0.3s;
  }

  #errorBox {
    color: #ff9e9e;
    background: rgba(255, 0, 0, 0.08);
    border: 1px solid rgba(255, 0, 0, 0.2);
    padding: 10px;
    border-radius: 8px;
    margin: 10px auto;
    width: 90%;
    max-width: 600px;
    display: none;
  }
</style>
</head>
<body>
  <div id="loader">
    <div>Caricamento giochi...</div>
    <div class="progress-container"><div class="progress-bar"></div></div>
    <div id="progress-text">0%</div>
  </div>

  <nav>
    <input type="text" id="search" placeholder="Cerca gioco...">
    <button data-filter="all" class="active">Tutti</button>
    <button data-filter="gba">GBA</button>
    <button data-filter="gbc">GBC</button>
    <button data-filter="gb">GB</button>
  </nav>

  <div id="errorBox"></div>
  <div class="game-grid" id="gameList"></div>
  <button class="arrow-up" id="arrowUp">↑</button>

  <script>
    const logos = {
      gba: "https://upload.wikimedia.org/wikipedia/commons/5/50/Game_Boy_Advance_logo.svg",
      gb: "https://upload.wikimedia.org/wikipedia/commons/f/f2/Nintendo_Game_Boy_Logo.svg",
      gbc: "https://upload.wikimedia.org/wikipedia/commons/c/c5/Game_Boy_Color_logo.svg"
    };

    const gameList = document.getElementById("gameList");
    const loader = document.getElementById("loader");
    const bar = document.querySelector(".progress-bar");
    const text = document.getElementById("progress-text");
    const errorBox = document.getElementById("errorBox");

    const sources = [
      "https://raw.githubusercontent.com/Neurone01/MorsEmulatores/refs/heads/main/games.json",
      "https://api.github.com/repos/AlexBlackmore/roms/contents/gba",
      "https://api.github.com/repos/AlexBlackmore/roms/contents/gb",
      "https://api.github.com/repos/AlexBlackmore/roms/contents/gbc"
    ];

    async function fetchSafe(url) {
      try {
        const res = await fetch(url);
        if (!res.ok) {
          console.warn(`⚠️ Errore HTTP ${res.status} su ${url}`);
          return { error: `HTTP ${res.status}`, data: null };
        }
        return { data: await res.json(), error: null };
      } catch (e) {
        console.warn(`⚠️ Errore rete/CORS per ${url}:`, e);
        return { error: e.message, data: null };
      }
    }

    async function fetchAll() {
      let allGames = [];
      let count = 0;
      let errors = [];

      for (const src of sources) {
        const { data, error } = await fetchSafe(src);
        if (error) errors.push(`❌ ${src}: ${error}`);

        if (Array.isArray(data)) {
          data.forEach(g => {
            if (g.name && (g.name.includes("(Europe)") || g.name.includes("(EUR)"))) {
              const system = src.includes("/gba") ? "gba" : src.includes("/gbc") ? "gbc" : src.includes("/gb") ? "gb" : "gba";
              allGames.push({
                name: g.name.replace(/\.(gba|gbc|gb)$/i,""),
                url: `https://cdn.jsdelivr.net/gh/AlexBlackmore/roms@master/${system}/${g.name}`,
                platform: system,
                image: logos[system]
              });
            }
          });
        }

        count++;
        const percent = Math.round((count / sources.length) * 100);
        bar.style.width = percent + "%";
        text.textContent = percent + "%";
      }

      if (errors.length) {
        errorBox.innerHTML = "<b>⚠️ Problemi rilevati:</b><br>" + errors.join("<br>");
        errorBox.style.display = "block";
      }

      allGames = allGames.sort(() => Math.random() - 0.5); // mescola
      allGames = allGames.filter((v,i,a)=>a.findIndex(t=>t.name===v.name)===i);
      return allGames;
    }

    function renderGames(list) {
      gameList.innerHTML = list.map(g => `
        <div class="game-card" data-platform="${g.platform}">
          <img src="${g.image}">
          <div class="title">${g.name}</div>
          <button onclick="play('${g.url}','${encodeURIComponent(g.name)}','${g.platform}')"
            style="margin-top:8px;padding:6px 12px;border:none;border-radius:8px;background:#004a88;color:#fff;cursor:pointer;">Play</button>
        </div>`).join('');
    }

    async function init() {
      const allGames = await fetchAll();
      loader.style.opacity = 0;
      setTimeout(()=>loader.style.display="none",1000);
      renderGames(allGames);
      setupNavbar(allGames);
    }

    function setupNavbar(allGames) {
      const search = document.getElementById("search");
      const buttons = document.querySelectorAll("nav button");
      let currentFilter = "all";

      function update() {
        const q = search.value.toLowerCase();
        let filtered = allGames.filter(g => g.name.toLowerCase().includes(q));
        if (currentFilter !== "all") {
          filtered = filtered.filter(g => g.platform === currentFilter);
        }
        renderGames(filtered);
      }

      buttons.forEach(btn => {
        btn.addEventListener("click", () => {
          buttons.forEach(b => b.classList.remove("active"));
          btn.classList.add("active");
          currentFilter = btn.dataset.filter;
          update();
        });
      });

      search.addEventListener("input", update);
      update();
    }

    function play(url, title, system) {
      const biosMap = {
        gba: "https://cdn.jsdelivr.net/gh/Neurone01/MorsEmulatores@main/Bios/gba_bios.bin",
        gbc: "https://cdn.jsdelivr.net/gh/Neurone01/MorsEmulatores@main/Bios/gbc_bios.bin",
        gb: "https://cdn.jsdelivr.net/gh/Neurone01/MorsEmulatores@main/Bios/dmg0_rom.bin"
      };
      location.href = `play.html?rom=${encodeURIComponent(url)}&title=${encodeURIComponent(title)}&system=${system}&bios=${encodeURIComponent(biosMap[system])}`;
    }

    const arrow = document.getElementById("arrowUp");
    window.addEventListener("scroll", () => {
      arrow.style.display = window.scrollY > 200 ? "block" : "none";
    });
    arrow.addEventListener("click", ()=>window.scrollTo({top:0,behavior:'smooth'}));

    init();
  </script>
</body>
</html>

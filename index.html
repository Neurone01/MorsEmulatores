<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Seleziona gioco</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;margin:0;padding:20px;background:#111;color:#eee}
    h1{margin:0 0 10px 0}
    .games{display:grid;grid-template-columns: repeat(auto-fit,minmax(220px,1fr));gap:12px}
    .card{background:#1b1b1b;border:1px solid #2b2b2b;padding:12px;border-radius:8px}
    .thumb{height:120px;background:#222;border-radius:6px;display:flex;align-items:center;justify-content:center;color:#888;margin-bottom:8px;overflow:hidden}
    .title{font-weight:600}
    .meta{font-size:0.95rem;color:#aaa}
    .btn{display:inline-block;margin-top:8px;padding:8px 10px;border-radius:6px;border:0;background:#0b84ff;color:white;text-decoration:none}
    .url-form{margin-top:18px;padding:10px;background:#0b0b0b;border-radius:8px;border:1px solid #222}
    label{display:block;margin-bottom:8px;color:#ddd}
    input[type="text"]{width:100%;padding:8px;border-radius:6px;border:1px solid #333;background:#111;color:#eee}
  </style>
</head>
<body>
  <h1>Scegli un gioco</h1>
  <div id="list" class="games">Caricamento giochi…</div>

  <div class="url-form">
    <label>Carica URL ROM direttamente (CORS richiesto):</label>
    <input id="directUrl" type="text" placeholder="https://archive.org/…/nome.gba" />
    <a id="playDirect" class="btn" href="#">Gioca URL diretto</a>
  </div>

  <script>
    async function loadList(){
      try{
        const r = await fetch('games.json', {cache: 'no-store'});
        if(!r.ok) throw new Error('games.json non trovato');
        const games = await r.json();
        render(games);
      }catch(err){
        document.getElementById('list').innerText = 'Errore caricamento games.json: ' + err;
      }
    }

    function render(games){
      const list = document.getElementById('list');
      list.innerHTML = '';
      for(const g of games){
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <div class="thumb">${g.thumbnail?`<img src="${g.thumbnail}" style="max-width:100%;height:100%;object-fit:cover">`:`<span style="font-size:0.9rem">${g.system.toUpperCase()}</span>`}</div>
          <div class="title">${escapeHtml(g.title)}</div>
          <div class="meta">${escapeHtml(g.system)} — ${g.id}</div>
          <a class="btn" href="play.html?id=${encodeURIComponent(g.id)}">Gioca</a>
        `;
        list.appendChild(card);
      }
    }

    function escapeHtml(s){ if(!s) return ''; return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

    document.getElementById('playDirect').addEventListener('click', (e)=>{
      e.preventDefault();
      const url = document.getElementById('directUrl').value.trim();
      if(!url){alert('Inserisci un URL valido');return}
      // reindirizza a play con param 'url'
      window.location.href = 'play.html?url=' + encodeURIComponent(url);
    });

    loadList();
  </script>
</body>
</html>
